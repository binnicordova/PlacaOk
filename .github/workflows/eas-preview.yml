name: EAS Preview App

on:
  pull_request:

permissions: write-all

env:
  ANDROID_PACKAGE: ${{ secrets.ANDROID_PACKAGE }}
  APP_NAME: ${{ secrets.APP_NAME }}
  APP_SCHEME: ${{ secrets.APP_SCHEME }}
  APP_SLUG: ${{ secrets.APP_SLUG }}
  APP_VERSION_CODE: ${{ secrets.APP_VERSION_CODE }}
  APP_VERSION_NAME: ${{ secrets.APP_VERSION_NAME }}
  EXPO_OWNER: ${{ secrets.EXPO_OWNER }}
  EXPO_PROJECT_ID: ${{ secrets.EXPO_PROJECT_ID }}
  IOS_BUNDLE_IDENTIFIER: ${{ secrets.IOS_BUNDLE_IDENTIFIER }}
  EXPO_PROJECT_ID: ${{ secrets.EXPO_PROJECT_ID }}

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - name: üèó Setup repo
        uses: actions/checkout@v3

      - name: üèó Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: yarn

      - name: üèó Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üì¶ Install dependencies
        run: yarn install

      - name: üöÄ Create preview
        uses: expo/expo-github-action/preview@v8
        with:
          command: eas update --auto --branch ${{ github.event.pull_request.head.ref }}

      - name: üì¶ eas update
        run: |
          eas update --branch preview --message 'Remote preview update'
          echo "Preview URL: https://expo.dev/@${{ env.EXPO_OWNER }}/${{ env.APP_SLUG }}?release-channel=preview"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EAS_BUILD_PROFILE: preview
